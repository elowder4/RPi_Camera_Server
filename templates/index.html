<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Raspberry Pi Camera Feed</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
            body {
                background-color: #f8f9fa;
            }
            .camera-feed {
                max-width: 100%;
                height: auto;
                border: 2px solid #dee2e6;
                border-radius: 8px;
            }
            .data-section {
                margin-top: 20px;
            }
            .data-item {
            margin-bottom: 10px;
            }
        </style>
    </head>
    <body>
        <div class="container text-center mt-5">
            <h1 class="mb-4">Prusa MK3S Live</h1>
            <img src="/frame.jpg" class="camera-feed" alt="Live camera feed" />
        
            <div class="data-section mt-4">
                <p class="fs-4 data-item" id="temperature">Temperature: <strong>Loading...</strong></p>
                <p class="fs-4 data-item" id="humidity">Humidity: <strong>Loading...</strong></p>
                <p class="fs-4 data-item" id="fps-stream">Stream FPS: <strong>Loading...</strong></p>
                <p class="fs-4 data-item" id="fps-capture">Capture FPS: <strong>Loading...</strong></p>
            </div>
        </div>
    </body>
    
    <script>
        const canvas = document.getElementById('videoCanvas');
        const ctx = canvas.getContext('2d');

        let lastFrameTime = performance.now();
        let fpsSamples = [];

        function fetchAndDrawFrame() {
            const img = new Image();
            img.onload = () => {
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                const now = performance.now();
                const delta = now - lastFrameTime;
                lastFrameTime = now;

                const fps = 1000 / delta;
                fpsSamples.push(fps);
                if (fpsSamples.length > 10) fpsSamples.shift();

                var avgFps = fpsSamples.reduce((a, b) => a + b, 0) / fpsSamples.length;

                // Fetch next frame
                requestAnimationFrame(fetchAndDrawFrame);
            };

            img.onerror = () => {
                console.warn("Frame load error. Retrying...");
                setTimeout(fetchAndDrawFrame, 100);
            };

            img.src = `/frame.jpg?t=${Date.now()}`; // prevent caching
        }

        function updateFPS() {
            fetch('/get_fps')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('fps-capture').textContent = data;
                    document.getElementById('fps-stream').textContent = avgFps.toFixed(1);
                })
                .catch(err => console.warn("Capture FPS fetch error:", err));
        }
        
        function updateDHT11() {
            fetch('/get_DHT11')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('temperature').textContent = data[0] + "Â°F";
                    document.getElementById('humidity').textContent = data[1] + "%";
                })
                .catch(err => console.warn("Capture DHT11 fetch error:", err));
        }
        

        setInterval(updateFPS, 500);
        setInterval(updateDHT11, 500);
        updateCaptureFPS(); // Initial call
        fetchAndDrawFrame(); // Start video loop
    </script>
</html>