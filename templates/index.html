<html>
    <head>
        <meta name = "viewport" content = "width = device-width, initial-scale=1">
        <style>
            img{ display: block;
                margin-left: auto;
                margin-right: auto;
            }
            canvas {
            display: block;
            margin: auto;
            }
            h1, p {
                text-align: center;
            }
        </style>
        <title>Prusa MK3S Stream</title>
    </head>
    
    <body>
        <h1>Prusa MK3S Live</h1>
        <p>Capture FPS: <span id="fps-capture">Loading...</span></p>
        <p>Stream FPS: <span id="fps-stream">Loading...</span></p>
        <canvas id="videoCanvas" width="640" height="480"></canvas>
    </body>
    
    <script>
        const canvas = document.getElementById('videoCanvas');
        const ctx = canvas.getContext('2d');

        let lastFrameTime = performance.now();
        let fpsSamples = [];

        function fetchAndDrawFrame() {
            const img = new Image();
            img.onload = () => {
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                const now = performance.now();
                const delta = now - lastFrameTime;
                lastFrameTime = now;

                const fps = 1000 / delta;
                fpsSamples.push(fps);
                if (fpsSamples.length > 10) fpsSamples.shift();

                const avgFps = fpsSamples.reduce((a, b) => a + b, 0) / fpsSamples.length;
                document.getElementById('fps-stream').textContent = avgFps.toFixed(1);

                // Fetch next frame
                requestAnimationFrame(fetchAndDrawFrame);
            };

            img.onerror = () => {
                console.warn("Frame load error. Retrying...");
                setTimeout(fetchAndDrawFrame, 100);
            };

            img.src = `/frame.jpg?t=${Date.now()}`; // prevent caching
        }

        function updateCaptureFPS() {
            fetch('/get_fps')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('fps-capture').textContent = data.toFixed(2);
                })
                .catch(err => console.warn("Capture FPS fetch error:", err));
        }

        setInterval(updateCaptureFPS, 1000);
        updateCaptureFPS(); // Initial call
        fetchAndDrawFrame(); // Start video loop
    </script>
</html>